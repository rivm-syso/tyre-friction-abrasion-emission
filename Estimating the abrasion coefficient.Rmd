---
title: "Estimating the abrasion coefficient"
author: "Joris T.K. Quik"
output: md_document
editor_options: 
  chunk_output_type: console
---

# Estimating the tyre abrasion coefficient

1. First data on the maneuvers, track, vehicle, tyres and abrassion measurements need to be combined into a dataset for use further calculations.
Then the following calculations are performed:
2. Total Force at all the tyres together
3. Total Slip at all tyres together
4. Calculate total Friction Work for the relevant abrassion measurement
5. Calculate the Abrasion Coefficient

## 1. Data prepartion
```{r data}
library(tidyverse)
source("R/Base functions.R")
local_path <- "data/TWP emission data_IDIADA_v01.xlsx"

n.Runs = 1000 # for clearly uncertrain variables, amount of values to use

Maneuver_data <- readxl::read_excel(path = local_path, sheet = "Maneuver data")

AllData <- 
  Maneuver_data |> 
  full_join(readxl::read_excel(path = local_path, sheet = "Sector data")) |> 
  cross_join(readxl::read_excel(path = local_path, sheet = "Vehicle data")) |> 
  full_join(readxl::read_excel(path = local_path, sheet = "Tyre_data"),relationship = "many-to-many") |> 
  full_join(readxl::read_excel(path = local_path, sheet = "Test data"))

Constants <- readxl::read_excel(path = local_path, sheet = "Constants")
# str(AllData)
# AllData$Vehicle_class

Tyre_Label_table_fuelEff =    readxl::read_excel(
  "data/Tyre_conversion.xlsx", 
  sheet = "Label fuel efficiency class",
  skip=1)
Tyre_Label_table_wetgrip =    readxl::read_excel(
  "data/Tyre_conversion.xlsx", 
  sheet = "Label wet grip class",
  skip=1)

AllData <-
  AllData |> 
  rowwise() |>  
  mutate(
    RolCoef_min =  fRolCoef_Tlabel(
      Label_fuelleff =
        `Fuel efficiency class`,
      Vehicle_class = Vehicle_class,
      Tyre_Label_table =
        Tyre_Label_table_fuelEff
    )$min,
    RolCoef_max = fRolCoef_Tlabel(
      Label_fuelleff =
        `Fuel efficiency class`,
      Vehicle_class = Vehicle_class,
      Tyre_Label_table = Tyre_Label_table_fuelEff
    )$max,
    GripIndex_min  = fGripIndex_Tlabel(
      Label_wetgrip = `Wet grip class`,
      Vehicle_class = Vehicle_class,
      Tyre_Label_table = Tyre_Label_table_wetgrip
    )$min,
    GripIndex_max = fGripIndex_Tlabel(
      Label_wetgrip = `Wet grip class`,
      Vehicle_class = Vehicle_class,
      Tyre_Label_table = Tyre_Label_table_wetgrip
    )$max
  )
# create n.Runs number of Rol Coefficients based on uncertainty of tyre label rol coefficient classes
AllData <-
  AllData |> mutate(
    RolCoef_u = list(runif(n.Runs, RolCoef_min, RolCoef_max)),
    GripIndex_u = list(runif(n.Runs, GripIndex_min, GripIndex_max)),
    
    x_correct_mu_max_track_u =
      switch(
        Underground,
        "Wet asphalt" = 1,
        "Dry asphalt" = list(
          runif(
            n.Runs,
            min =  Constants |>
              filter(Name == "x_correct_mu_max_wet2dry_min") |>
              pull(value),
            max =  Constants |>
              filter(Name == "x_correct_mu_max_wet2dry_max") |>
              pull(value)
          )
        )
      ),
    
    optimal_slip_ratio_track_u =
      switch(
        Underground,
        "Wet asphalt" = list(
          runif(
            n.Runs,
            min =  Constants |>
              filter(Name == "optimal_slip_wet_min") |>
              pull(value),
            max =  Constants |>
              filter(Name == "optimal_slip_wet_max") |>
              pull(value)
          )
        ),
        "Dry asphalt" = list(
          runif(
            n.Runs,
            min =  Constants |>
              filter(Name == "optimal_slip_dry_min") |>
              pull(value),
            max =  Constants |>
              filter(Name == "optimal_slip_dry_max") |>
              pull(value)
          )
        )
      )
  )


### end data prep ###


```


## 2. Total Force
Longitutidal and Lattidunal forces are calculated

```{r force}
AllData <-
  AllData |> mutate(
    ForceDecelLong =
      list(
        f_decel_long_force(
          c_roll = RolCoef_u,
          m_vehicle = `Mass (kg)`,
          grav_constant = Constants |>
            filter(Name == "grav_constant") |> pull(value),
          c_drag = `Aero_drag_coef (-)`,
          A_vehicle = `Surface_Area (m2)`,
          rho_air = Constants |>
            filter(Name == "rho_air") |> pull(value),
          v_start_decel = `Start speed (m/s)`,
          v_end_decel = `End speed (m/s)`,
          v_wind = v_wind,
          alpha_slope = `Longitudinal slope (%)` / 100,
          m_rotate = runif(
            n.Runs,
            Constants |>
              filter(Name == "min_rotating_fraction") |> pull(value),
            Constants |>
              filter(Name == "max_rotating_fraction") |> pull(value)
          ),
          c_decel = `Deceleration constant (m.s^-2)`
        )
      ),
    ForceAccelLong =
      list(
        f_accel_long_force(
          c_roll = RolCoef_u,
          m_vehicle = `Mass (kg)`,
          grav_constant = Constants |>
            filter(Name == "grav_constant") |> pull(value),
          c_drag = `Aero_drag_coef (-)`,
          A_vehicle = `Surface_Area (m2)`,
          rho_air = Constants |>
            filter(Name == "rho_air") |> pull(value),
          v_start_accel = `Start speed (m/s)`,
          v_end_accel = `End speed (m/s)`,
          v_wind = v_wind,
          alpha_slope = `Longitudinal slope (%)` / 100,
          m_rotate = runif(
            n.Runs,
            Constants |>
              filter(Name == "min_rotating_fraction") |> pull(value),
            Constants |>
              filter(Name == "max_rotating_fraction") |> pull(value)
          ),
          c_accel = `Acceleration constant (m.s^-2)`
        )
      ),
    ForceConstLong =
      list(
        f_const_speed_long_force(
          c_roll = RolCoef_u,
          m_vehicle = `Mass (kg)`,
          grav_constant = Constants |>
            filter(Name == "grav_constant") |> pull(value),
          c_drag = `Aero_drag_coef (-)`,
          A_vehicle = `Surface_Area (m2)`,
          rho_air = Constants |>
            filter(Name == "rho_air") |> pull(value),
          v_vehicle = `End speed (m/s)`,
          v_wind = `v_wind`,
          alpha_slope = `Longitudinal slope (%)` /100)
      ),
    ForceCornLatt_M =
      list(
        f_lat_force( m_vehicle = `Mass (kg)`,
                     grav_constant = Constants |> 
                       filter(Name == "grav_constant") |> pull(value),
                     r_corner = `Corner radius (m)`,
                     alpha_bank_slope = `Latitudinal slope (%)` / 100,
                     v_vehicle = mean(`Start speed (m/s)`,`End speed (m/s)`)) 
      ),
    ForceCornLatt_C =
      list(
        f_lat_force( m_vehicle = `Mass (kg)`,
                     grav_constant = Constants |> 
                       filter(Name == "grav_constant") |> pull(value),
                     r_corner = `Corner radius (m)`,
                     alpha_bank_slope = `Latitudinal slope (%)` / 100,
                     v_vehicle = `End speed (m/s)`) 
      )
  )

```

## 3. Total Slip

```{r slip}
# add slipt to the data:

AllData <-
  AllData |> mutate(
    SlipDecelLong =
      list(
        f_decel_long_slip(c_roll = RolCoef_u, 
                          m_vehicle = `Mass (kg)`, 
                          grav_constant = Constants |> 
                            filter(Name == "grav_constant") |> pull(value), 
                          c_drag = `Aero_drag_coef (-)`, 
                          A_vehicle = `Surface_Area (m2)`,
                          rho_air = Constants |> 
                            filter(Name == "rho_air") |> pull(value),
                          v_start_decel = `Start speed (m/s)`, 
                          v_end_decel = `End speed (m/s)`, 
                          v_wind = `v_wind`,
                          alpha_slope = `Longitudinal slope (%)`/100, 
                          m_rotate = runif(n.Runs,
                                           Constants |> 
                                             filter(Name == "min_rotating_fraction") |> 
                                             pull(value),
                                           Constants |> 
                                             filter(Name == "max_rotating_fraction") |> 
                                             pull(value)), 
                          c_decel = `Deceleration constant (m.s^-2)`, 
                          optimal_slip_ratio_tyre_track = optimal_slip_ratio_track_u,
                          grip_index_tyre = GripIndex_u,
                          wet_mu_max_ref_tyre = Constants |>
                            filter(Name == "mu_max_ref_tyre_wet") |> pull(value),
                          x_correct_mu_max_track = x_correct_mu_max_track_u,
                          c_brake_ref_tyre_wet = Constants |> 
                            filter(Name == "c_brake_ref_tyre_wet") |> pull(value)
        ) 
      ),
    SlipAccelLong= list(
      f_accel_long_slip(c_roll = RolCoef_u, 
                        m_vehicle = `Mass (kg)`, 
                        grav_constant = Constants |> 
                          filter(Name == "grav_constant") |> pull(value), 
                        c_drag = `Aero_drag_coef (-)`, 
                        A_vehicle = `Surface_Area (m2)`, 
                        rho_air = Constants |> 
                          filter(Name == "rho_air") |> pull(value),
                        v_start_accel = `Start speed (m/s)`, 
                        v_end_accel = `End speed (m/s)`, 
                        v_wind = v_wind, 
                        alpha_slope = `Longitudinal slope (%)`/100, 
                        m_rotate = runif(n.Runs,
                                         Constants |> 
                                           filter(Name == "min_rotating_fraction") |> 
                                           pull(value),
                                         Constants |> 
                                           filter(Name == "max_rotating_fraction") |> 
                                           pull(value)), 
                        c_accel = `Acceleration constant (m.s^-2)`, 
                        optimal_slip_ratio_tyre_track = optimal_slip_ratio_track_u,
                        grip_index_tyre = GripIndex_u, 
                        wet_mu_max_ref_tyre = Constants |> 
                          filter(Name == "mu_max_ref_tyre_wet") |> pull(value),
                        x_correct_mu_max_track = x_correct_mu_max_track_u)
    ),
    SlipConstLong = 
      list(
        f_const_speed_long_slip(c_roll = RolCoef_u, 
                                m_vehicle = `Mass (kg)`, 
                                m_rotate = runif(n.Runs,
                                                 Constants |> 
                                                   filter(Name == "min_rotating_fraction") |> 
                                                   pull(value),
                                                 Constants |> 
                                                   filter(Name == "max_rotating_fraction") |> 
                                                   pull(value)),
                                grav_constant = Constants |> 
                                  filter(Name == "grav_constant") |> pull(value), 
                                c_drag = `Aero_drag_coef (-)`, 
                                A_vehicle = `Surface_Area (m2)`, 
                                rho_air = Constants |> 
                                  filter(Name == "rho_air") |> pull(value), 
                                v_vehicle = `End speed (m/s)`, 
                                v_wind = `v_wind`,
                                alpha_slope = `Longitudinal slope (%)`/100,
                                wet_mu_max_ref_tyre = Constants |> 
                                  filter(Name == "mu_max_ref_tyre_wet") |> pull(value), 
                                optimal_slip_ratio_tyre_track = optimal_slip_ratio_track_u,
                                grip_index_tyre = GripIndex_u, 
                                c_brake_ref_tyre_wet = Constants |> 
                                  filter(Name == "c_brake_ref_tyre_wet") |> pull(value), 
                                x_correct_mu_max_track = x_correct_mu_max_track_u)
      ),
    SlipCornLatt_M =
      list(
        f_lat_slip(m_vehicle = `Mass (kg)`, 
                   v_vehicle = mean(`Start speed (m/s)`,
                                    `End speed (m/s)`), 
                   r_corner = `Corner radius (m)`, 
                   grav_constant = Constants |> 
                     filter(Name == "grav_constant") |> pull(value),
                   alpha_bank_slope = `Latitudinal slope (%)`/100, 
                   optimal_slip_ratio_tyre_track = optimal_slip_ratio_track_u,
                   grip_index_tyre = GripIndex_u, 
                   wet_mu_max_ref_tyre = Constants |> 
                     filter(Name == "mu_max_ref_tyre_wet") |> pull(value), 
                   x_correct_mu_max_track = x_correct_mu_max_track_u)
      ),
    SlipCornLatt_C =
      list(
        f_lat_slip(m_vehicle = `Mass (kg)`, 
                   v_vehicle = `End speed (m/s)`, 
                   r_corner = `Corner radius (m)`, 
                   grav_constant = Constants |> 
                     filter(Name == "grav_constant") |> pull(value),
                   alpha_bank_slope = `Latitudinal slope (%)`/100, 
                   optimal_slip_ratio_tyre_track = optimal_slip_ratio_track_u,
                   grip_index_tyre = GripIndex_u, 
                   wet_mu_max_ref_tyre = Constants |> 
                     filter(Name == "mu_max_ref_tyre_wet") |> pull(value), 
                   x_correct_mu_max_track = x_correct_mu_max_track_u)
      ) 
  )


```

## 4. Total Friction Work

```{r FrictionWork}
AllData_fw <- 
  AllData |> mutate(
    DistanceManAccel =
      f_accel_distance(v_start = `Start speed (m/s)`,
                       v_end = `End speed (m/s)`,
                       c_accel = `Acceleration constant (m.s^-2)`),
    DistanceManDecel = 
      f_decel_distance(v_start = `Start speed (m/s)`,
                       v_end = `End speed (m/s)`,
                       c_decel = `Deceleration constant (m.s^-2)`),
    DistanceCorn = f_corner_distance(r_corner = `Corner radius (m)`,
                                     corner_angle = `Corner angle (degrees)`),
  )  |> mutate(DistanceConst = `Distance (m)`-
                 DistanceManAccel*`Maneuver repeats` - 
                 DistanceManDecel*`Maneuver repeats`,
               FWAccelLong = list(ForceAccelLong*SlipAccelLong*DistanceManAccel*`Maneuver repeats`),
               FWDecelLong = list(ForceDecelLong*SlipDecelLong*DistanceManDecel*`Maneuver repeats`),
               FWConstLong = list(ForceConstLong*SlipConstLong*DistanceConst),
               FWLat = list(
                 SlipCornLatt_M*ForceCornLatt_M*(DistanceManAccel+DistanceManDecel) +
                   SlipCornLatt_C*ForceCornLatt_C*DistanceConst),
               FricWork_p_sector = list((FWAccelLong+FWDecelLong+FWConstLong+FWLat))
               
  )

AllData_fw$FricWork_p_km
test2<-
  AllData_fw |> ungroup() |> 
  group_by(AbrasionTest,Tyre_brand,`Vehicle type`,Scenario,`Sector number`,`Maneuver number`,`Test section`) |> 
  unnest(FricWork_p_sector)

length(test2$Track)
test2 <- test2 |>  mutate(RUN = rep(1:1000))

FW1 <-
  test2 |> ungroup() |> 
  group_by(AbrasionTest,Tyre_brand,`Vehicle type`,Scenario,`Test section`,RUN,`Total distance (km)`) |> 
  summarise(sector_count = n(),
            PartFrictionWork = sum(FricWork_p_sector)) |> 
    mutate(SectionFrictionWork = PartFrictionWork *`Total distance (km)`)

test2 |>  ungroup() |> 
  group_by(AbrasionTest,Tyre_brand,`Vehicle type`,Scenario,RUN,`Total distance (km)`) |> 
  summarise(Section_count = n(),
            TotFrictionWork = sum(SectionFrictionWork),
            Test_Distance_km = sum(`Total distance (km)`)) |> 
  mutate(FW_p_km = TotFrictionWork/Test_Distance_km)

### end of FW

```

## 5. Abrasion Coefficient

```{r abrasion coeff}

# read in and prepare abrasion rate measurement data
IDIADAwear <- readxl::read_excel(path = local_path, sheet = "Abrasion", skip = 9)

#provide proper column names
names(IDIADAwear)[c(1,2)] <- c("Tyre_brand","Wheel")

# extend Tyre to all its rows
for(i in 1:nrow(IDIADAwear)){
  if(is.na(IDIADAwear$Tyre_brand[i])){
    IDIADAwear$Tyre_brand[i] <- IDIADAwear$Tyre_brand[i-1]
  }
}

#What?
IDIADAwear$C0 <- NULL

# clean up rows with NA and calculated data
IDIADAwear <- 
  IDIADAwear |> separate(col = Tyre_brand,
                         into =c("Tyre_brand", "Scenario"),
                         sep = "     ")|> 
  filter(!is.na(Wheel)) |> 
  filter(Wheel != "Total") |> 
  filter( Wheel != "Front") |> 
  filter(Wheel != "Rear") 

#Track to long format
WearAsLong <- tidyr::pivot_longer(IDIADAwear, 
                                  cols = names(IDIADAwear)[!names(IDIADAwear) %in% c("Tyre_brand","Wheel","Scenario")],
                                  names_to = c("Shift","AbrasionTest"),
                                  names_sep = "-",
                                  values_to = "Abrasion_mg_km")

WearAsLong <-
  WearAsLong |> mutate(
    AbrasionTest = 
      AbrasionTest |> recode(
        "Runin" = "Run-in",
        "Rur" = "Rural",
        "Mot" = "Motorway",
        "Ur" = "Urban"
      ),
    Scenario = Scenario |> 
      replace_na("Standard")
  )
unique(WearAsLong$Tyre_brand)
test <- left_join(WearAsLong,AllData)
test <- inner_join(WearAsLong,AllData)
unique(test$Abrasion_mg_km)
length(test$Abrasion_mg_km)
length(WearAsLong$Abrasion_mg_km)
unique(test$Scenario)
unique(AllData$Scenario)
test |> filter(Scenario == "High temperature")



test2 <-
  test |> group_by(AbrasionTest,Scenario,Tyre_brand, Shift) |> 
  summarise(Abrasionsum = sum(Abrasion_mg_km))

```

